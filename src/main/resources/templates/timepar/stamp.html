<!DOCTYPE html>
<html lang="ko" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{thymeleaf/layout/default}">
<th:block layout:fragment="css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" href="/timepar/css/bootstrap.css">

    <link rel="stylesheet" href="/timepar/css/style.css">
    <style>
        th.par3{ background-color: #01022b; color: #fff;}
        th.par4{ background-color: #072607; color: #fff;}
        th.par5{ background-color: #821302; color: #fff;}

    </style>

</th:block>
<th:block layout:fragment="script">
    <script type="text/javascript">
        let app = '';
        let SECOND = 1000;
        let MINUTE = 60;
        $(document).ready(function () {
            app = new Vue({
                el: "#app",
                data: function () {
                    return {
                        search : {
                            gameId : '[[${gameId}]]',
                            roundNo : '[[${roundNo}]]',
                        },
                        gameInfo : {},
                        course :{},
                        hole:{},
                        groupHole : {},
                        list : [],
                        timer : {
                            lastTime : '',
                            woker : '',
                            time : 0,
                            timer : 0,
                        },
                        lineArr : [],
                        zoomNo : '1',
                    }
                },
                created: function () {
                    const self = this;
                    let resp = doAjax('/timepar/game.tf', {});
                    self.search.gameId = resp.data.gameId;
                    self.search.roundNo = resp.data.roundNo;

                    resp = doAjax('/api/game.tf', { apcYear : new Date().getFullYear(), tourId : '11', gameId : self.search.gameId});
                    self.gameInfo = resp.data[0];
                    resp = doAjax('/api/course.tf', { gameId : self.search.gameId});
                    self.course = resp.data[0];
                    resp = doAjax('/timepar/hole.tf', self.search);
                    self.hole = resp.data;
                    resp = doAjax('/timepar/stand.tf', self.search);
                    let groupHole = {};
                    resp.data.forEach(function (info) {
                        groupHole['group' + info.group_no] = info;
                    });
                    self.groupHole = groupHole;
                    self.getList();
                    self.timer.woker = setInterval(function(){self.getList();}, 10 * SECOND);
                    self.timer.timer = setInterval(function(){self.timer.time++;}, SECOND);
                },
                methods: {
                    getList : function() {
                        let self = this;
                        let resp = doAjax('/timepar/stamp.tf', self.search);
                        let inout = 'OUT'
                        let ampm = 'AM';
                        let lineArr = [0];
                        self.timer.time = 0;
                        self.list = resp.data.map(function (info,idx) {
                            for (let i = Number(info.start_hole_no); i < Number(info.start_hole_no) + 18; i++) {
                                let holeNo = i > 18 ? i - 18 : i;

                                let holeStandTime = moment(self.groupHole['group'+info.group_no]['hole' + holeNo]);
                                let holeRealTimeStr = info['hole'+ holeNo +'_end'];
                                let holeRealTime = moment(holeRealTimeStr);
                                info['holeStandTime' + holeNo] = holeStandTime.format('HH:mm');
                                let holeTime = Math.floor(((holeRealTime - holeStandTime)/SECOND/MINUTE));
                                info['holeTime' + holeNo] = holeTime;
                                let className = '';
                                if(holeTime == 0 || !holeRealTimeStr ){
                                    className = 'even';
                                } else if(holeTime < 0){
                                    className = holeTime*-1 > 9 ? 'minus2' : 'minus';
                                } else if(holeTime > 0){
                                    className = holeTime > 9 ? 'plus2' : 'plus';
                                }
                                info['className' + holeNo] = className;
                            }
                            if(info.start_am_pm != ampm || info.start_in_out != inout){
                                inout = info.start_in_out;
                                ampm = info.start_am_pm
                                lineArr.push(idx);
                            }
                            return info;
                        })
                        self.lineArr = lineArr;
                        self.timer.lastTime = moment().format('YYYY년 MM월 DD일  HH시mm분ss초')
                    },
                    getHoleTime : function (info, holeNo) {
                        let times = info['holeTime' +holeNo ];
                        return info['hole'+ holeNo +'_end'] ? times : info['holeStandTime' +holeNo ];
                    },
                    fnZoom : function (zoomNo) {
                        let self = this;
                        self.zoomNo = zoomNo;
                    }
                }
            });
        });
    </script>
</th:block>
</head>

<body layout:fragment="content" >
    <div id="app">
        <div id="container2">
            <h1>Pace of Play Time</h1>
            <div id="tourinfo">{{ gameInfo.gameName }} {{ search.roundNo }}R</div>
            <div class="btn-group" role="group">
                <a class="btn btn-primary" role="button" @click="getList()">
                     Refresh <span >{{ timer.time }}</span>
                </a>
            </div>
            <div><span id="time">{{ timer.lastTime }}</span></div>
            <div id="tablewrap">
                <table id="tablestroke" :style="'transform: scale(' + zoomNo + '); transform-origin: 0px 0px;'">
                    <tbody>
                        <template v-for="(info, idx) in list">
                            <tr v-if="lineArr.indexOf(idx)>-1">
                                <th>No</th>
                                <th v-for="holeNo in 9" :class="'par' + course['holePar'+holeNo]"> {{ holeNo }} </th>
                                <th>No</th>
                                <th v-for="holeNo in 9" :class="'par' + course['holePar'+(holeNo+9)]"> {{ holeNo +9 }} </th>
                                <th>No</th>
                            </tr>
                            <tr >
                                <th><a href="##"> {{ info.group_no }} </a></th>
                                <td v-for="holeNo in 9"  :class="info['className' + holeNo ]"> {{ getHoleTime(info, holeNo)}} </td>
                                <th><a href="##"> {{ info.group_no }} </a></th>
                                <td v-for="holeNo in 9"  :class="info['className' + (holeNo+9) ]"> {{ getHoleTime(info, (holeNo+9)) }} </td>
                                <th><a href="##"> {{ info.group_no }} </a></th>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <div id="zoomCont" class="btn-group btn-group-justified" role="group">
                <a href="#" :class="'zoom50 btn btn-default ' + (zoomNo == '0.5' ? 'active' : '')" @click="fnZoom(0.5)"  role="button">
                    <span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span>Full
                </a>
                <a href="#" :class="'zoom50 btn btn-default ' + (zoomNo == '1' ? 'active' : '')" @click="fnZoom(1)" role="button">
                    <span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span>2x
                </a>
                <a href="#" :class="'zoom50 btn btn-default ' + (zoomNo == '1.5' ? 'active' : '')" @click="fnZoom(1.5)" role="button">
                    <span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span>3x
                </a>
                <a href="#" :class="'zoom50 btn btn-default ' + (zoomNo == '2.0' ? 'active' : '')"  @click="fnZoom(2.0)" role="button">
                    <span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span>4x
                </a>
            </div>
        </div>
    </div>
</body>
</html>