<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.unbiz.api.mapper.TimeparMapper">
    <select id="selectTimeparHole" parameterType="Map" resultType="Map">
        /**selectTimeparHole*/
        SELECT
            t1.game_id
             ,t1.hole1              ,t1.hole10
             ,t1.hole2              ,t1.hole11
             ,t1.hole3              ,t1.hole12
             ,t1.hole4              ,t1.hole13
             ,t1.hole5              ,t1.hole14
             ,t1.hole6              ,t1.hole15
             ,t1.hole7              ,t1.hole16
             ,t1.hole8              ,t1.hole17
             ,t1.hole9              ,t1.hole18
        FROM kpga.tb_timepar_hole t1
        WHERE t1.game_id = #{gameId}
          AND t1.round_no = #{roundNo}
        LIMIT 1
    </select>

    <select id="selectTimeparStand" parameterType="Map" resultType="Map">
        /**selectTimeparStand*/
        SELECT
              t1.group_no                                                  ,DATE_FORMAT(t1.start_time, '%Y-%m-%d %H:%i:%s') start_time
             ,DATE_FORMAT(t1.hole1, '%Y-%m-%d %H:%i:%s') hole1            ,DATE_FORMAT(t1.hole10, '%Y-%m-%d %H:%i:%s') hole10
             ,DATE_FORMAT(t1.hole2, '%Y-%m-%d %H:%i:%s') hole2            ,DATE_FORMAT(t1.hole11, '%Y-%m-%d %H:%i:%s') hole11
             ,DATE_FORMAT(t1.hole3, '%Y-%m-%d %H:%i:%s') hole3            ,DATE_FORMAT(t1.hole12, '%Y-%m-%d %H:%i:%s') hole12
             ,DATE_FORMAT(t1.hole4, '%Y-%m-%d %H:%i:%s') hole4            ,DATE_FORMAT(t1.hole13, '%Y-%m-%d %H:%i:%s') hole13
             ,DATE_FORMAT(t1.hole5, '%Y-%m-%d %H:%i:%s') hole5            ,DATE_FORMAT(t1.hole14, '%Y-%m-%d %H:%i:%s') hole14
             ,DATE_FORMAT(t1.hole6, '%Y-%m-%d %H:%i:%s') hole6            ,DATE_FORMAT(t1.hole15, '%Y-%m-%d %H:%i:%s') hole15
             ,DATE_FORMAT(t1.hole7, '%Y-%m-%d %H:%i:%s') hole7            ,DATE_FORMAT(t1.hole16, '%Y-%m-%d %H:%i:%s') hole16
             ,DATE_FORMAT(t1.hole8, '%Y-%m-%d %H:%i:%s') hole8            ,DATE_FORMAT(t1.hole17, '%Y-%m-%d %H:%i:%s') hole17
             ,DATE_FORMAT(t1.hole9, '%Y-%m-%d %H:%i:%s') hole9            ,DATE_FORMAT(t1.hole18, '%Y-%m-%d %H:%i:%s')  hole18
        FROM kpga.tb_timepar_stand t1
        WHERE t1.game_id = #{gameId}
          AND t1.round_no = #{roundNo}
    </select>

    <select id="selectTimeparStamp" parameterType="Map" resultType="Map">
        /**selectTimeparStamp*/
        SELECT
            t1.group_no , t2.start_time, t2.start_hole_no , t2.start_am_pm , t2.start_in_out
           ,DATE_FORMAT(t1.hole1_end   , '%Y-%m-%d %H:%i:%s')  hole1_end
           ,DATE_FORMAT(t1.hole2_end   , '%Y-%m-%d %H:%i:%s')  hole2_end
           ,DATE_FORMAT(t1.hole3_end   , '%Y-%m-%d %H:%i:%s')  hole3_end
           ,DATE_FORMAT(t1.hole4_end   , '%Y-%m-%d %H:%i:%s')  hole4_end
           ,DATE_FORMAT(t1.hole5_end   , '%Y-%m-%d %H:%i:%s')  hole5_end
           ,DATE_FORMAT(t1.hole6_end   , '%Y-%m-%d %H:%i:%s')  hole6_end
           ,DATE_FORMAT(t1.hole7_end   , '%Y-%m-%d %H:%i:%s')  hole7_end
           ,DATE_FORMAT(t1.hole8_end   , '%Y-%m-%d %H:%i:%s')  hole8_end
           ,DATE_FORMAT(t1.hole9_end   , '%Y-%m-%d %H:%i:%s')  hole9_end
           ,DATE_FORMAT(t1.hole10_end  , '%Y-%m-%d %H:%i:%s')  hole10_end
           ,DATE_FORMAT(t1.hole11_end  , '%Y-%m-%d %H:%i:%s')  hole11_end
           ,DATE_FORMAT(t1.hole12_end  , '%Y-%m-%d %H:%i:%s')  hole12_end
           ,DATE_FORMAT(t1.hole13_end  , '%Y-%m-%d %H:%i:%s')  hole13_end
           ,DATE_FORMAT(t1.hole14_end  , '%Y-%m-%d %H:%i:%s')  hole14_end
           ,DATE_FORMAT(t1.hole15_end  , '%Y-%m-%d %H:%i:%s')  hole15_end
           ,DATE_FORMAT(t1.hole16_end  , '%Y-%m-%d %H:%i:%s')  hole16_end
           ,DATE_FORMAT(t1.hole17_end  , '%Y-%m-%d %H:%i:%s')  hole17_end
           ,DATE_FORMAT(t1.hole18_end  , '%Y-%m-%d %H:%i:%s')  hole18_end
        FROM kpga.tb_timepar_stamp t1
        LEFT OUTER JOIN kpga_db.game_round_starttime t2
        ON t1.game_id = t2.game_id AND t1.round_no = t2.round_no AND t1.group_no = t2.exp_group_no
        LEFT OUTER JOIN kpga_db.game_round t3 ON t1.game_id = t3.game_id AND t1.round_no = t3.round_no
        WHERE t1.game_id = #{gameId}
        AND t1.round_no = #{roundNo}
        <if test="groupNo != '' and groupNo != null">AND t1.group_no = #{groupNo}</if>
        ORDER BY t2.start_am_pm, t2.start_in_out DESC, t2.start_time
    </select>

    <insert id="insertTimeparHole" parameterType="Map">
        /*insertTimeparHole*/
        DELETE FROM kpga.tb_timepar_stand WHERE game_id = #{gameId} AND round_no = #{roundNo};

        INSERT INTO kpga.tb_timepar_stand
            (game_id, round_no, group_no, start_time
            , hole1, hole2, hole3, hole4, hole5, hole6, hole7, hole8, hole9
            , hole10, hole11, hole12, hole13, hole14, hole15, hole16, hole17, hole18) VALUES
        <foreach collection="data" item="t" separator=",">
        (#{gameId}, #{roundNo}, #{t.group_no}, #{t.start_time}
        , #{t.hole1}, #{t.hole2}, #{t.hole3}, #{t.hole4}, #{t.hole5}, #{t.hole6}, #{t.hole7}, #{t.hole8}, #{t.hole9}
        , #{t.hole10}, #{t.hole11}, #{t.hole12}, #{t.hole13}, #{t.hole14}, #{t.hole15}, #{t.hole16}, #{t.hole17}, #{t.hole18}) </foreach>
    </insert>

    <select id="selectTimeparGame" resultType="Map">
        /**insertTimeparGame*/
        SELECT t1.game_id gameId, t1.round_no roundNo
        FROM kpga.tb_timepar_game t1
        WHERE t1.seq = (SELECT MAX(t2.seq) FROM kpga.tb_timepar_game t2)
    </select>


    <insert id="insertTimeparGame">
        /**insertTimeparGame*/
        INSERT INTO kpga.tb_timepar_game (game_id, round_no) VALUES (#{gameId}, #{roundNo})
    </insert>

    <insert id="insertTimeparStamp">
        /**insertTimeparStamp*/
        INSERT INTO kpga.tb_timepar_stamp (game_id, round_no, group_no)
        SELECT t1.game_id ,t1.round_no,t1.exp_group_no
        FROM kpga_db.game_round_starttime t1
        LEFT OUTER JOIN kpga.tb_timepar_stamp t2
        ON t1.game_id = t2.game_id AND t1.round_no = t2.round_no AND t1.exp_group_no = t2.group_no
        WHERE t1.game_id = #{gameId} AND t1.round_no = #{roundNo} AND t2.game_id IS NULL
    </insert>

    <update id="updateTimeparStamp">
        UPDATE kpga.tb_timepar_stamp
        SET hole${holeNo}_end = CASE WHEN #{endDate} = 'del' THEN NULL ELSE #{endDate} END
        WHERE game_id = #{gameId} AND round_no = #{roundNo} AND group_no = #{groupNo}

    </update>

    <resultMap id="TimeparGroupMap" type="com.unbiz.api.model.TimeparGroup">
        <result property="gameId"						column="gameId"		/>
        <result property="roundNo"						column="roundNo"		/>
        <result property="holeNo"						column="holeNo"		/>
        <result property="memberId"						column="memberId"		/>
        <result property="startTimeId"					column="startTimeId"		/>
        <result property="groupNum"						column="groupNum"		/>
        <result property="playerName"					column="playerName"		/>
        <result property="score"					    column="score"		/>

        <collection property="shotList"
                    column="{gameId = gameId, roundNo = roundNo, memberId = memberId, holeNo = holeNo}"
                    select="selectTimeparPlayerShot" />
    </resultMap>

    <select id="selectTimeparGroup" resultMap="TimeparGroupMap">
        /**selectTimeparGroup*/
        SELECT
            t1.game_id                  gameId
            ,t1.round_no                roundNo
            ,t2.member_id               memberId
            ,#{holeNo}                  holeNo
            ,t1.start_time_id           startTimeId
            ,t1.exp_group_no            groupNum
            ,t3.player_name             playerName
            ,t2.score_${holeNo}         score
        FROM kpga_db.game_round_starttime t1
        JOIN kpga_db.game_score t2
        ON t1.game_id = t2.game_id
        AND t1.round_no = t2.round_no AND t1.start_time_id = t2.start_time_id
        JOIN kpga_db.game_player t3
        ON t2.game_id = t3.game_id AND t2.member_id = t3.member_id
        WHERE t1.game_id = #{gameId}
          AND t1.round_no = #{roundNo}
          AND t1.exp_group_no = #{groupNo};

    </select>

    <select id="selectTimeparPlayerShot" resultType="Map">
        /**selectTimeparPlayerShot*/
        SELECT
            t1.shot_no          shotNo
            ,t1.`field`         `field`
        FROM kpga.track3d_shot_info t1
        WHERE t1.game_id = #{gameId}
          AND t1.round_no = #{roundNo}
          AND t1.member_id = #{memberId}
          AND t1.hole_no = #{holeNo}
        ORDER BY t1.shot_no
    </select>

    <select id="selectFullswingDataTime" resultType="Map">
    /**selectFullswingDataTime*/
        SELECT
            t1.hole_no              holeNo
            ,MAX(t1.reg_date)       regDate
        FROM kpga.kpsa_full_swing t1
        JOIN kpga.tb_timepar_game t2
        ON t1.game_id = t2.game_id
        AND t1.round_no = t2.round_no
        AND t2.seq = (SELECT MAX(t0.seq) FROM kpga.tb_timepar_game t0)
        GROUP BY t1.hole_no;
    </select>

</mapper>